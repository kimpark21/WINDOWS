name: SAMP_UBUNTU_STABLE

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install System Dependencies (32-bit)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          # Install library inti yang dibutuhkan oleh hampir semua plugin SAMP
          sudo apt-get install -y libc6:i386 libncurses5:i386 libstdc++6:i386 libsqlite3-0:i386
          # Library SSL dan MariaDB Client (versi generik)
          sudo apt-get install -y libssl-dev:i386 libmariadb3:i386 || echo "Library tambahan opsional tidak ditemukan, lanjut..."

      - name: Setup & Start MySQL
        run: |
          sudo systemctl start mysql
          # Membuat database dengan nama 'database'
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS database;"
          # Jika ingin import otomatis, pastikan file .sql ada di repo dan hapus tanda # di bawah:
          # sudo mysql -u root database < Database/s115_Nusantara.sql

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=samp-linux

      - name: Install Playit.gg
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/playit.gpg
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit -y

      - name: Start SAMP Server
        run: |
          # Memberikan izin akses eksekusi
          chmod +x samp03svr
          chmod +x announce
          
          echo "=== MEMULAI SAMP SERVER ==="
          # Menjalankan server di background
          ./samp03svr & 
          sleep 5
          
          echo "=== KONFIGURASI PLAYIT ==="
          # Jalankan playit untuk menjaga workflow tetap hidup
          playit
