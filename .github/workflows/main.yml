name: SAMP_UBUNTU_FINAL

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install System Dependencies (32-bit)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          # Install library dasar 32-bit yang wajib untuk SAMP
          sudo apt-get install -y libc6:i386 libncurses5:i386 libstdc++6:i386 libssl1.1:i386 || sudo apt-get install -y libssl3:i386
          # Install MariaDB/MySQL Client agar plugin MySQL .so bisa jalan
          sudo apt-get install -y libmariadb-dev:i386 || sudo apt-get install -y libmariadb-client-lgpl-dev:i386

      - name: Setup & Start MySQL
        run: |
          sudo systemctl start mysql
          # Membuat database dengan nama 'database' (sesuaikan jika perlu)
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS database;"
          # Jika kamu punya file .sql di repo, hilangkan tanda # di bawah ini untuk import otomatis:
          # sudo mysql -u root database < Database/s115_Nusantara.sql

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=samp-linux

      - name: Install Playit.gg
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/playit.gpg
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit -y

      - name: Start SAMP Server
        run: |
          # Beri izin eksekusi pada file Linux SAMP
          chmod +x samp03svr
          chmod +x announce
          
          echo "=== MENJALANKAN SERVER SAMP ==="
          # Jalankan server di background agar workflow tidak stop
          ./samp03svr & 
          sleep 5
          
          echo "=== MENJALANKAN TUNNEL PLAYIT ==="
          # Playit akan berjalan di foreground untuk menjaga workflow tetap aktif
          playit
