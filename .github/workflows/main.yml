name: SAMP_UBUNTU_PRO

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # Maksimal 6 jam sesuai limit GitHub

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install System Dependencies (32-bit)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt update
          # Install library yang dibutuhkan agar plugin .so bisa jalan
          sudo apt install -y lib32stdc++6 lib32z1 libmariadb-dev-compat:i386 libssl-dev:i386 libnode-dev:i386

      - name: Install & Setup MySQL
        run: |
          sudo systemctl start mysql
          # Membuat database sesuai nama di script kamu
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS database;"
          # Pastikan file .sql kamu ada di repo, jika ada hapus tanda pagar di bawah:
          # sudo mysql -u root database < database.sql

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=samp-ubuntu

      - name: Install Playit.gg
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/playit.gpg
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt update
          sudo apt install playit -y

      - name: Start SAMP Server & Playit
        run: |
          # Memberikan izin eksekusi pada file server
          chmod +x samp03svr
          chmod +x announce
          
          echo "=== MENJALANKAN SERVER SAMP ==="
          # Menjalankan server di background
          ./samp03svr & 
          
          echo "=== MENJALANKAN TUNNEL PLAYIT ==="
          # Menjalankan playit.gg
          # Catatan: Pada jalankan pertama, kamu perlu cek log untuk link aktivasi playit
          playit
